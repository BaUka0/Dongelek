{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Create{% endif %} Car Listing - Dongelek{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        padding: 25px;
        margin-bottom: 20px;
    }
    .form-section-title {
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e9ecef;
    }
    .required label:after {
        content: " *";
        color: red;
    }
    .photo-upload-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
    }
    .photo-upload-box {
        width: 150px;
        height: 150px;
        border: 1px dashed #ced4da;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        background-color: #f8f9fa;
    }
    .photo-upload-box.with-image {
        border: none;
    }
    .photo-upload-box.main-photo {
        border: 2px solid #28a745;
    }
    .main-photo-badge {
        position: absolute;
        top: 5px;
        left: 5px;
        background-color: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        z-index: 3;
    }
    .photo-upload-box.marked-for-deletion {
        opacity: 0.5;
        border: 2px dashed #dc3545;
    }
    .delete-badge {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: #dc3545;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        z-index: 3;
    }
    .photo-upload-box input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 2;
    }
    .main-upload-box {
        width: 250px;
        height: 250px;
    }
    .upload-icon {
        font-size: 2rem;
        color: #6c757d;
        margin-bottom: 10px;
    }
    .upload-preview {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .photo-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: space-between;
        padding: 5px 10px;
        color: white;
        z-index: 3;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .photo-upload-box:hover .photo-controls {
        opacity: 1;
    }
    .set-main-btn {
        cursor: pointer;
        color: white;
    }
    .delete-photo-btn {
        cursor: pointer;
        color: white;
    }
    .add-more-photos {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 0.9rem;
    }
    .cross-icon {
        font-size: 2.5rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <h1 class="mb-4">{% if form.instance.pk %}Edit{% else %}Create{% endif %} Car Listing</h1>
        
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="form-section">
                <h3 class="form-section-title">Basic Information</h3>
                <div class="row">
                    <div class="col-md-6 mb-3 required">
                        <label for="{{ form.brand.id_for_label }}" class="form-label">Brand</label>
                        <div class="input-group">
                            <select name="{{ form.brand.name }}" id="{{ form.brand.id_for_label }}" class="form-select">
                                <option value="">Select a Brand</option>
                                {% for choice in form.brand.field.queryset %}
                                    <option value="{{ choice.id }}" {% if form.brand.value|stringformat:"i" == choice.id|stringformat:"i" %}selected{% endif %}>
                                        {{ choice }}
                                    </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addBrandModal">+</button>
                        </div>
                        {% if form.brand.errors %}
                            <div class="text-danger">{{ form.brand.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3 required">
                        <label for="{{ form.model.id_for_label }}" class="form-label">Model</label>
                        <div class="input-group">
                            <select name="{{ form.model.name }}" id="{{ form.model.id_for_label }}" class="form-select">
                                <option value="">Select a Model</option>
                                {% if form.model.field.queryset %}
                                    {% for choice in form.model.field.queryset %}
                                        <option value="{{ choice.id }}" {% if form.model.value|stringformat:"i" == choice.id|stringformat:"i" %}selected{% endif %}>
                                            {{ choice }}
                                        </option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary" id="addModelBtn" data-bs-toggle="modal" data-bs-target="#addModelModal" {% if not form.brand.value %}disabled{% endif %}>+</button>
                        </div>
                        {% if form.model.errors %}
                            <div class="text-danger">{{ form.model.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3 required">
                        <label for="{{ form.year.id_for_label }}" class="form-label">Year</label>
                        <select name="{{ form.year.name }}" id="{{ form.year.id_for_label }}" class="form-select">
                            <option value="">Select Year</option>
                            {% for year in ""|ljust:"40" %}
                                {% with year_val=forloop.counter|add:1985 %}
                                    <option value="{{ year_val }}" {% if form.year.value|add:"0" == year_val %}selected{% endif %}>{{ year_val }}</option>
                                {% endwith %}
                            {% endfor %}
                        </select>
                        {% if form.year.errors %}
                            <div class="text-danger">{{ form.year.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4 mb-3 required">
                        <label for="{{ form.price.id_for_label }}" class="form-label">Price (₸)</label>
                        <input type="number" name="{{ form.price.name }}" id="{{ form.price.id_for_label }}" class="form-control" value="{{ form.price.value|default_if_none:'' }}" step="1000">
                        {% if form.price.errors %}
                            <div class="text-danger">{{ form.price.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4 mb-3 required">
                        <label for="{{ form.mileage.id_for_label }}" class="form-label">Mileage (km)</label>
                        <input type="number" name="{{ form.mileage.name }}" id="{{ form.mileage.id_for_label }}" class="form-control" value="{{ form.mileage.value|default_if_none:'' }}">
                        {% if form.mileage.errors %}
                            <div class="text-danger">{{ form.mileage.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3 class="form-section-title">Car Specifications</h3>
                <div class="row">
                    <div class="col-md-6 mb-3 required">
                        <label for="{{ form.fuel_type.id_for_label }}" class="form-label">Fuel Type</label>
                        <select name="{{ form.fuel_type.name }}" id="{{ form.fuel_type.id_for_label }}" class="form-select">
                            {% for choice in form.fuel_type.field.choices %}
                                <option value="{{ choice.0 }}" {% if form.fuel_type.value == choice.0 %}selected{% endif %}>
                                    {{ choice.1 }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if form.fuel_type.errors %}
                            <div class="text-danger">{{ form.fuel_type.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3 required">
                        <label for="{{ form.transmission.id_for_label }}" class="form-label">Transmission</label>
                        <select name="{{ form.transmission.name }}" id="{{ form.transmission.id_for_label }}" class="form-select">
                            {% for choice in form.transmission.field.choices %}
                                <option value="{{ choice.0 }}" {% if form.transmission.value == choice.0 %}selected{% endif %}>
                                    {{ choice.1 }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if form.transmission.errors %}
                            <div class="text-danger">{{ form.transmission.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3 required">
                        <label for="{{ form.body_type.id_for_label }}" class="form-label">Body Type</label>
                        <select name="{{ form.body_type.name }}" id="{{ form.body_type.id_for_label }}" class="form-select">
                            {% for choice in form.body_type.field.choices %}
                                <option value="{{ choice.0 }}" {% if form.body_type.value == choice.0 %}selected{% endif %}>
                                    {{ choice.1 }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if form.body_type.errors %}
                            <div class="text-danger">{{ form.body_type.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3 required">
                        <label for="{{ form.drive_type.id_for_label }}" class="form-label">Drive Type</label>
                        <select name="{{ form.drive_type.name }}" id="{{ form.drive_type.id_for_label }}" class="form-select">
                            {% for choice in form.drive_type.field.choices %}
                                <option value="{{ choice.0 }}" {% if form.drive_type.value == choice.0 %}selected{% endif %}>
                                    {{ choice.1 }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if form.drive_type.errors %}
                            <div class="text-danger">{{ form.drive_type.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3 required">
                        <label for="{{ form.color.id_for_label }}" class="form-label">Color</label>
                        <input type="text" name="{{ form.color.name }}" id="{{ form.color.id_for_label }}" class="form-control" value="{{ form.color.value|default_if_none:'' }}">
                        {% if form.color.errors %}
                            <div class="text-danger">{{ form.color.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.engine_size.id_for_label }}" class="form-label">Engine Size (L)</label>
                        <input type="number" name="{{ form.engine_size.name }}" id="{{ form.engine_size.id_for_label }}" class="form-control" value="{{ form.engine_size.value|default_if_none:'' }}" step="0.1">
                        {% if form.engine_size.errors %}
                            <div class="text-danger">{{ form.engine_size.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3 class="form-section-title">Location in Kazakhstan</h3>
                <div class="row">
                    <div class="col-md-6 mb-3 required">
                        <label for="{{ form.region.id_for_label }}" class="form-label">Oblast (Область)</label>
                        <select name="{{ form.region.name }}" id="{{ form.region.id_for_label }}" class="form-select">
                            <option value="">Select an Oblast</option>
                            {% for choice in form.region.field.queryset %}
                                <option value="{{ choice.id }}" {% if form.region.value|stringformat:"i" == choice.id|stringformat:"i" %}selected{% endif %}>
                                    {{ choice }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if form.region.errors %}
                            <div class="text-danger">{{ form.region.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3 required">
                        <label for="{{ form.city.id_for_label }}" class="form-label">City/District (Город/Район)</label>
                        <select name="{{ form.city.name }}" id="{{ form.city.id_for_label }}" class="form-select">
                            <option value="">Select a City/District</option>
                            {% if form.city.field.queryset %}
                                {% for choice in form.city.field.queryset %}
                                    <option value="{{ choice.id }}" {% if form.city.value|stringformat:"i" == choice.id|stringformat:"i" %}selected{% endif %}>
                                        {{ choice }}
                                    </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                        {% if form.city.errors %}
                            <div class="text-danger">{{ form.city.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3 class="form-section-title">Description</h3>
                <div class="mb-3 required">
                    <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                    <textarea name="{{ form.description.name }}" id="{{ form.description.id_for_label }}" class="form-control" rows="5">{{ form.description.value|default_if_none:'' }}</textarea>
                    {% if form.description.errors %}
                        <div class="text-danger">{{ form.description.errors }}</div>
                    {% endif %}
                    <div class="form-text">Provide a detailed description of the car, including its condition, unique features, and reason for selling.</div>
                </div>
            </div>
            
            <div class="form-section">
                <h3 class="form-section-title">Images</h3>
                <p class="text-muted mb-3">You can upload from 1 to 10 photos. One image must be set as the main image shown in listings.</p>
                
                {{ image_formset.management_form }}
                
                <div class="alert alert-info">
                    Please select at least one image for your car listing.
                </div>
                
                {% if image_formset.non_form_errors %}
                <div class="alert alert-danger">
                    {% for error in image_formset.non_form_errors %}
                        {{ error }}<br>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="photo-upload-container" id="photo-upload-container">
                    
                    <!-- Initial photo upload box -->
                    <div class="photo-upload-box {% if image_formset.0.instance.pk and image_formset.0.instance.image %}with-image{% endif %} {% if image_formset.0.instance.is_primary %}main-photo{% endif %}" id="photo-box-0">
                        <input type="file" name="images-0-image" id="id_images-0-image" accept="image/*" class="photo-input" data-index="0">
                        {{ image_formset.0.id }}
                        {% if image_formset.0.instance.pk and image_formset.0.instance.image %}
                            {% if image_formset.0.instance.is_primary %}
                            <div class="main-photo-badge">Main Photo</div>
                            {% endif %}
                            <img src="{{ image_formset.0.instance.image.url }}" alt="Car image" class="upload-preview">
                            <div class="photo-controls">
                                {% if not image_formset.0.instance.is_primary %}
                                <span class="set-main-btn" data-index="0"><i class="fas fa-star"></i> Set as main</span>
                                {% endif %}
                                <span class="delete-photo-btn" data-index="0"><i class="fas fa-trash"></i> Delete</span>
                            </div>
                            <input type="checkbox" name="images-0-DELETE" id="id_images-0-DELETE" class="delete-checkbox" style="display: none;">
                        {% else %}
                            <div class="upload-icon"><i class="fas fa-arrow-up"></i></div>
                            <span>Upload photo</span>
                        {% endif %}
                        <input type="hidden" name="images-0-is_primary" id="id_images-0-is_primary" value="{% if image_formset.0.instance.is_primary %}True{% else %}False{% endif %}" class="is-primary-input">
                        
                    </div>
                    
                    <!-- Additional photo upload boxes -->
                    {% for image_form in image_formset %}
                        {% if forloop.counter0 > 0 %}
                            <div class="photo-upload-box {% if image_form.instance.pk and image_form.instance.image %}with-image{% endif %} {% if image_form.instance.is_primary %}main-photo{% endif %}" 
                                 id="photo-box-{{ forloop.counter0 }}" 
                                 style="{% if not image_form.instance.pk %}display: none;{% endif %}">
                                <input type="file" name="images-{{ forloop.counter0 }}-image" id="id_images-{{ forloop.counter0 }}-image" accept="image/*" class="photo-input" data-index="{{ forloop.counter0 }}">
                                {{ image_form.id }}
                                {% if image_form.instance.pk and image_form.instance.image %}
                                    {% if image_form.instance.is_primary %}
                                    <div class="main-photo-badge">Main Photo</div>
                                    {% endif %}
                                    <img src="{{ image_form.instance.image.url }}" alt="Car image" class="upload-preview">
                                    <div class="photo-controls">
                                        {% if not image_form.instance.is_primary %}
                                        <span class="set-main-btn" data-index="{{ forloop.counter0 }}"><i class="fas fa-star"></i> Set as main</span>
                                        {% endif %}
                                        <span class="delete-photo-btn" data-index="{{ forloop.counter0 }}"><i class="fas fa-trash"></i> Delete</span>
                                    </div>
                                    <input type="checkbox" name="images-{{ forloop.counter0 }}-DELETE" id="id_images-{{ forloop.counter0 }}-DELETE" class="delete-checkbox" style="display: none;">
                                {% else %}
                                    <div class="upload-icon"><i class="fas fa-arrow-up"></i></div>
                                    <span>Upload photo</span>
                                {% endif %}
                                <input type="hidden" name="images-{{ forloop.counter0 }}-is_primary" id="id_images-{{ forloop.counter0 }}-is_primary" value="{% if image_form.instance.is_primary %}True{% else %}False{% endif %}" class="is-primary-input">
                                
                            </div>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Add more photos button -->
                    <div class="photo-upload-box add-more-photos" id="add-more-photos">
                        <div class="cross-icon">+</div>
                        <span>Add more photos</span>
                    </div>
                </div>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-5">
                <a href="{% if form.instance.pk %}{{ form.instance.get_absolute_url }}{% else %}{% url 'car_list' %}{% endif %}" class="btn btn-secondary me-md-2">Cancel</a>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Brand Modal -->
<div class="modal fade" id="addBrandModal" tabindex="-1" aria-labelledby="addBrandModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBrandModalLabel">Add New Brand</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new-brand-name" class="form-label">Brand Name</label>
                    <input type="text" class="form-control" id="new-brand-name" placeholder="Enter brand name">
                    <div class="invalid-feedback" id="brand-error-feedback"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-brand-btn">Save Brand</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Model Modal -->
<div class="modal fade" id="addModelModal" tabindex="-1" aria-labelledby="addModelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModelModalLabel">Add New Model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="model-brand-display" class="form-label">Brand</label>
                    <input type="text" class="form-control" id="model-brand-display" readonly>
                </div>
                <div class="mb-3">
                    <label for="new-model-name" class="form-label">Model Name</label>
                    <input type="text" class="form-control" id="new-model-name" placeholder="Enter model name">
                    <div class="invalid-feedback" id="model-error-feedback"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-model-btn">Save Model</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Set first image as primary by default if no primary image exists
        if ($('.is-primary-input[value="True"]').length === 0) {
            $('#id_images-0-is_primary').val('True');
        }
        
        // Handle dynamic change of car models when brand is selected
        $('#{{ form.brand.id_for_label }}').change(function() {
            const brandId = $(this).val();
            if (brandId) {
                $.ajax({
                    url: "{% url 'ajax_load_models' %}",
                    data: { 'brand': brandId },
                    dataType: 'json',
                    success: function(data) {
                        const modelSelect = $('#{{ form.model.id_for_label }}');
                        modelSelect.html('<option value="">Select a Model</option>');
                        data.models.forEach(function(model) {
                            modelSelect.append(`<option value="${model.id}">${model.name}</option>`);
                        });
                        $('#addModelBtn').prop('disabled', false);
                    }
                });
            } else {
                $('#{{ form.model.id_for_label }}').html('<option value="">Select a Model</option>');
                $('#addModelBtn').prop('disabled', true);
            }
        });
        
        // Handle dynamic change of cities when region is selected
        $('#{{ form.region.id_for_label }}').change(function() {
            const regionId = $(this).val();
            if (regionId) {
                $.ajax({
                    url: "{% url 'ajax_load_cities' %}",
                    data: { 'region': regionId },
                    dataType: 'json',
                    success: function(data) {
                        const citySelect = $('#{{ form.city.id_for_label }}');
                        citySelect.html('<option value="">Select a City/District</option>');
                        data.cities.forEach(function(city) {
                            citySelect.append(`<option value="${city.id}">${city.name}</option>`);
                        });
                    }
                });
            } else {
                $('#{{ form.city.id_for_label }}').html('<option value="">Select a City/District</option>');
            }
        });
        
        // Handle image preview and UI updates
        $('.photo-input').change(function() {
            const input = this;
            const photoBox = $(this).closest('.photo-upload-box');
            const index = $(input).data('index');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Remove existing preview elements
                    photoBox.find('.upload-icon, span:not(.photo-controls *, .set-main-btn, .main-photo-badge)').remove();
                    
                    // Add or update preview image
                    if (photoBox.find('img.upload-preview').length) {
                        photoBox.find('img.upload-preview').attr('src', e.target.result);
                    } else {
                        photoBox.append(`<img src="${e.target.result}" alt="Car image" class="upload-preview">`);
                        
                        // Add controls
                        const isFirstUpload = $('.photo-upload-box.with-image').length === 0;
                        let controlsHtml = `
                            <div class="photo-controls">
                                ${!isFirstUpload ? `<span class="set-main-btn" data-index="${index}"><i class="fas fa-star"></i> Set as main</span>` : ''}
                                <span class="delete-photo-btn" data-index="${index}"><i class="fas fa-trash"></i> Delete</span>
                            </div>
                            <input type="checkbox" name="images-${index}-DELETE" id="id_images-${index}-DELETE" class="delete-checkbox" style="display: none;">
                        `;
                        photoBox.append(controlsHtml);
                        
                        // If this is the first uploaded photo, set it as main
                        if (isFirstUpload) {
                            setAsMainPhoto(index);
                        }
                    }
                    
                    photoBox.addClass('with-image');
                    
                    // Show the next photo box if available
                    if (index === 0) {
                        $('#photo-box-1').show();
                    }
                }
                
                reader.readAsDataURL(input.files[0]);
            }
        });
        
        // Function to set a photo as the main one
        function setAsMainPhoto(index) {
            // Remove main-photo class and badge from all photos
            $('.photo-upload-box').removeClass('main-photo');
            $('.main-photo-badge').remove();
            
            // Set all is_primary fields to false
            $('.is-primary-input').val('False');
            
            // Set the selected photo as main
            $(`#photo-box-${index}`).addClass('main-photo');
            $(`#photo-box-${index}`).prepend('<div class="main-photo-badge">Main Photo</div>');
            $(`#id_images-${index}-is_primary`).val('True');
            
            console.log(`Set photo ${index} as main`);
            
            // Update the controls - hide "Set as main" for the main photo, show for others
            $('.set-main-btn').show();
            $(`#photo-box-${index} .set-main-btn`).hide();
        }
        
        // Handle "Set as main" button clicks
        $(document).on('click', '.set-main-btn', function(e) {
            e.stopPropagation(); // Prevent event bubbling
            const index = $(this).data('index');
            setAsMainPhoto(index);
        });
        
        // Handle photo deletion
        $(document).on('click', '.delete-photo-btn', function(e) {
            e.stopPropagation(); // Prevent event bubbling
            const index = $(this).data('index');
            const photoBox = $(`#photo-box-${index}`);
            const deleteCheckbox = $(`#id_images-${index}-DELETE`);
            
            // Toggle the delete checkbox
            if (deleteCheckbox.prop('checked')) {
                deleteCheckbox.prop('checked', false);
                photoBox.removeClass('marked-for-deletion');
                photoBox.find('.delete-badge').remove();
                
                // If this was a primary photo that was marked for deletion, restore primary status
                if (photoBox.hasClass('main-photo')) {
                    photoBox.find('.main-photo-badge').show();
                }
            } else {
                deleteCheckbox.prop('checked', true);
                photoBox.addClass('marked-for-deletion');
                photoBox.append('<div class="delete-badge">Will be deleted</div>');
                
                // If this is the primary photo, we need to set another one as primary
                if (photoBox.hasClass('main-photo')) {
                    photoBox.find('.main-photo-badge').hide();
                    
                    // Find another visible photo that isn't marked for deletion
                    const anotherPhoto = $('.photo-upload-box.with-image:visible').not(`#photo-box-${index}`).not('.marked-for-deletion').first();
                    if (anotherPhoto.length) {
                        setAsMainPhoto(anotherPhoto.attr('id').replace('photo-box-', ''));
                    }
                }
            }
            
            // Update "add more" button visibility
            updateAddMoreButtonVisibility();
        });
        
        // Function to update "add more" button visibility
        function updateAddMoreButtonVisibility() {
            const visibleBoxes = $('.photo-upload-box:visible').not('#add-more-photos').not('.marked-for-deletion').length;
            
            if (visibleBoxes >= 10) {
                $('#add-more-photos').hide();
            } else {
                $('#add-more-photos').show();
            }
        }
        
        // Add more photos functionality
        $('#add-more-photos').click(function() {
            // Find the next hidden photo box
            const nextBox = $('.photo-upload-box:hidden').first();
            
            if (nextBox.length) {
                console.log(`Showing next photo box: ${nextBox.attr('id')}`);
                nextBox.show();
                
                // Check if we've reached the maximum number of photos (10)
                const visibleBoxes = $('.photo-upload-box:visible').not('#add-more-photos').length;
                console.log(`Visible boxes: ${visibleBoxes}`);
                if (visibleBoxes >= 10) {
                    $('#add-more-photos').hide();
                }
            }
        });
        
        // Count visible photo boxes on page load and hide "add more" if needed
        const visibleBoxesOnLoad = $('.photo-upload-box:visible').not('#add-more-photos').length;
        if (visibleBoxesOnLoad >= 10) {
            $('#add-more-photos').hide();
        }
        
        // Handle brand creation
        $('#save-brand-btn').click(function() {
            const brandName = $('#new-brand-name').val().trim();
            
            if (!brandName) {
                $('#new-brand-name').addClass('is-invalid');
                $('#brand-error-feedback').text('Brand name is required');
                return;
            }
            
            $.ajax({
                url: "{% url 'ajax_create_brand' %}",
                method: 'POST',
                data: {
                    'brand_name': brandName,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                dataType: 'json',
                success: function(data) {
                    if (data.success) {
                        // Add new brand to dropdown and select it
                        const brandSelect = $('#{{ form.brand.id_for_label }}');
                        brandSelect.append(`<option value="${data.id}">${data.name}</option>`);
                        brandSelect.val(data.id).trigger('change');
                        
                        // Close modal and reset form
                        $('#addBrandModal').modal('hide');
                        $('#new-brand-name').val('');
                    } else {
                        $('#new-brand-name').addClass('is-invalid');
                        $('#brand-error-feedback').text(data.error);
                    }
                },
                error: function() {
                    $('#new-brand-name').addClass('is-invalid');
                    $('#brand-error-feedback').text('An error occurred. Please try again.');
                }
            });
        });
        
        // Update model modal with selected brand
        $('#addModelModal').on('show.bs.modal', function() {
            const brandId = $('#{{ form.brand.id_for_label }}').val();
            const brandText = $('#{{ form.brand.id_for_label }} option:selected').text();
            $('#model-brand-display').val(brandText);
        });
        
        // Handle model creation
        $('#save-model-btn').click(function() {
            const modelName = $('#new-model-name').val().trim();
            const brandId = $('#{{ form.brand.id_for_label }}').val();
            
            if (!modelName) {
                $('#new-model-name').addClass('is-invalid');
                $('#model-error-feedback').text('Model name is required');
                return;
            }
            
            $.ajax({
                url: "{% url 'ajax_create_model' %}",
                method: 'POST',
                data: {
                    'model_name': modelName,
                    'brand_id': brandId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                dataType: 'json',
                success: function(data) {
                    if (data.success) {
                        // Add new model to dropdown and select it
                        const modelSelect = $('#{{ form.model.id_for_label }}');
                        modelSelect.append(`<option value="${data.id}">${data.name}</option>`);
                        modelSelect.val(data.id);
                        
                        // Close modal and reset form
                        $('#addModelModal').modal('hide');
                        $('#new-model-name').val('');
                    } else {
                        $('#new-model-name').addClass('is-invalid');
                        $('#model-error-feedback').text(data.error);
                    }
                },
                error: function() {
                    $('#new-model-name').addClass('is-invalid');
                    $('#model-error-feedback').text('An error occurred. Please try again.');
                }
            });
        });
        
        // Reset validation state when typing
        $('#new-brand-name').on('input', function() {
            $(this).removeClass('is-invalid');
        });
        
        $('#new-model-name').on('input', function() {
            $(this).removeClass('is-invalid');
        });
    });
</script>
{% endblock %}